---
layout: prototype-without-header
title: Annotations
---

<main>
<form class="annotation-details dark-mode">

  <header class="annotation-details__header">

    <div class="annotation-details__header-title">
      <h1 class="heading-4">Edit annotations</h1>

      <p class="annotation-details__header-meta body-4">
        These edits will mark this image as verified
      </p>
    </div>

    <div class="annotation-details__header-action">
      <a
        href="/"
        class="button button--medium"
        >
        <svg class="icon icon--small"><use xlink:href="#icon-chevron-down"></use></svg>
        Add annotation
      </a>
    </div>

  </header>

  <figure
    class="annotation-details__figure"
    data-annotation-figure
    style="
      --image-width: 1920;
      --image-height: 1080;
      "
    >
    <img class="annotation-details__figure-image" src="https://fathomnet.org/static/m3/framegrabs/Doc%20Ricketts/images/0620/03_19_38_11.png" alt="Paragorgia arborea" />
    <svg data-resizable-svg aria-label="Concepts" data-onClick="window.onSvgClick(event)" class="annotation-details__figure-svg" viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg">
      <g style="--color: #26BF9B;" data-annotation-box data-annotation-id="concept-1">
        <text fill="white" x="1040" y="440" style="font-size: 3em" class="annotation">Bathochordaeus</text>
        <path data-resizable data-draggable="move" fill="rgba(38, 191, 155, 0.16)" stroke-width="5" stroke="white"
          d="
            m 1040 140
            h 500
            v 300
            h -500
            z
          ">
        </path>
        <circle data-draggable="top-left" fill="rgba(38, 191, 155, 0.3)" stroke-width="5" stroke="#26BF9B" cx="1040" cy="140" r="20"/>
        <circle data-draggable="top-right" fill="rgba(38, 191, 155, 0.3)" stroke-width="5" stroke="#26BF9B" cx="1540" cy="140" r="20"/>
        <circle data-draggable="bottom-right" fill="rgba(38, 191, 155, 0.3)" stroke-width="5" stroke="#26BF9B" cx="1540" cy="440" r="20"/>
        <circle data-draggable="bottom-left" fill="rgba(38, 191, 155, 0.3)" stroke-width="5" stroke="#26BF9B" cx="1040" cy="440" r="20"/>
      </g>
      <g style="--color: #11AFF0;" data-annotation-box data-annotation-id="concept-2">
        <text fill="white" x="640" y="640" style="font-size: 3em" class="annotation">Paragorgia arborea</text>
        <path fill="none" stroke-width="10" stroke="white"
          d="
            m 640 240
            h 500
            v 400
            h -500
            z
          ">
        </path>
      </g>
      <g style="--color: #EF5DA7;" data-annotation-box data-annotation-id="concept-3">
        <text fill="white" x="400" y="700" style="font-size: 3em" class="annotation">Aegina</text>
        <path fill="none" stroke-width="10" stroke="white"
          d="
            m 400 400
            h 300
            v 300
            h -300
            z
          ">
        </path>
      </g>
    </svg>
    <div class="annotation-details__figure-field-container">
      <ul class="annotation-details__figure-field-list">
        <li class="annotation-details__figure-field-item">
          <label style="--field-x: 1040; --field-y: 440;" class="field field--has-placeholder field--has-icon annotation-field" data-annotation-field="hidden" data-annotation-id="concept-1">
            <span class="field__label">Annotation</span>
            <input
              type="text"
              class="field__input"
              value="Bathochordaeus"
              placeholder="Annotation"
              list="search-concepts" />
            <svg class="icon field__icon"><use xlink:href="#icon-edit"></use></svg>
          </label>
        </li>
        <li class="annotation-details__figure-field-item">
          <label style="--field-x: 640; --field-y: 640;" class="field field--has-placeholder field--has-icon annotation-field" data-annotation-field="hidden" data-annotation-id="concept-2">
            <span class="field__label">Annotation</span>
            <input
              type="text"
              class="field__input"
              value="Paragorgia arborea"
              placeholder="Annotation"
              list="search-concepts" />
            <svg class="icon field__icon"><use xlink:href="#icon-edit"></use></svg>
          </label>
        </li>
        <li class="annotation-details__figure-field-item">
          <label style="--field-x: 400; --field-y: 700;"  class="field field--has-placeholder field--has-icon annotation-field" data-annotation-field="hidden" data-annotation-id="concept-3">
            <span class="field__label">Annotation</span>
            <input
              type="text"
              class="field__input"
              value="Aegina"
              placeholder="Annotation"
              list="search-concepts" />
            <svg class="icon field__icon"><use xlink:href="#icon-edit"></use></svg>
          </label>
        </li>
      </ul>
      {% include datalist.html %}
    </div>
  </figure>

  <script>
  function closest(element, tagName) {

    // If the element is the target
    if (element.nodeName.toLowerCase() === tagName) return element;

    var ancestor = element;
    while ((ancestor = ancestor.parentElement) && ancestor.nodeName && ancestor.nodeName.toLowerCase() !== tagName);
    if (ancestor && ancestor.nodeName && ancestor.nodeName.toLowerCase() === tagName) {
      return ancestor;
    }
  }
  let activeCaption, activateAnnotationID, activeFieldContainer, activeField;
  function activateAnnotation() {
    const box = document.querySelector(`[data-annotation-box][data-annotation-id=${activateAnnotationID}]`);
    
    const parent = box.parentNode;
    parent.removeChild(box);
    parent.appendChild(box);

    activeCaption = box.querySelector("text");
    activeFieldContainer = document.querySelector(`[data-annotation-field][data-annotation-id=${activateAnnotationID}]`);
    activeField = activeFieldContainer.querySelector(`input`);
    console.log({activeCaption, activeFieldContainer, activeField});

    activeFieldContainer.setAttribute("data-annotation-field", "visible");
    activeField.addEventListener("keyup", updateCaption);
    activeField.addEventListener("blur", deactivateAnnotation);
    activeField.focus();
  }
  function deactivateAnnotation() {
    if (activeFieldContainer && activeField) {
      activeFieldContainer.setAttribute("data-annotation-field", "hidden");
      activeField.removeEventListener("keyup", updateCaption);
      activeField.removeEventListener("blur", deactivateAnnotation);
    }
    activeFieldContainer = null;
    activeField = null;
    activeCaption = null;
  }
  function onSvgClick(event) {
    console.log(event.target);
    const group = closest(event.target, "g");

    deactivateAnnotation();
    activateAnnotationID = group.getAttribute("data-annotation-id");
    console.log({activateAnnotationID});
    activateAnnotation();
  }
  function updateCaption() {
    if (activeField && activeCaption) {
      activeCaption.textContent = activeField.value;
    }
  }
  const annotationsFields = document.querySelectorAll("[data-annotation-field] input");
  for (const field of annotationsFields) {
    field.addEventListener("focus", (event) => {
      console.log(event.target);
      const label = closest(field, "label");

      deactivateAnnotation();
      activateAnnotationID = label.getAttribute("data-annotation-id");
      console.log({activateAnnotationID});
      activateAnnotation();
    });
  }
  </script>
  <script>
  console.log(`Draggable`);
  class Draggable {
    getTouchPosition(e) {
      let point = {};

      if (e.targetTouches) {
        point.x = e.targetTouches[0].clientX;
        point.y = e.targetTouches[0].clientY;
      }

      return point;
    }
    getMousePosition(e) {
      let point = {};

      if (e.clientX) {
        point.x = e.clientX;
        point.y = e.clientY;
      }

      return point;
    }
    multiTouch(e) {
      return (e.touches && e.touches.length > 1);
    }
    onTouchStart(e) {
      console.log(`onTouchStart`);
      if (this.multiTouch(e)) return;
      this.setInitialTouch(this.getTouchPosition(e));
      e.preventDefault();
    }
    onMouseDown(e) {
      console.log(`onMouseDown`);
      this.setInitialTouch(this.getMousePosition(e));
      e.preventDefault();
    }
    onTouchMove(e) {
      if (this.multiTouch(e)) return;
      // this.determineTouchDirection(this.getTouchPosition(e));
      this.transform = this.getMoveTransform(this.getTouchPosition(e));
      this.handleInteraction();
      e.preventDefault();
    }
    onMouseMove(e) {
      if (
        !this.initialTouch ||
        !this.initialTouch.y
      ) {
        return; // this.transform;
      }
      // this.determineTouchDirection(this.getTouchPosition(e));
      this.transform = this.getMoveTransform(this.getMousePosition(e));
      this.handleInteraction();
      e.preventDefault();
    }
    onTouchEnd(e) {
      console.log(`onTouchEnd`);
      if (this.multiTouch(e)) return;
      this.onTouchRelease();
      e.preventDefault();
    }
    onMouseUp(e) {
      console.log(`onTouchEnd`);
      this.onTouchRelease();
      e.preventDefault();
    }
    setInitialTouch(touch) {
      this.initialTouch = touch;
    }

    handleInteraction() {
      console.log({transform: this.transform});
      switch (this.targetType) {
        case "move":
          // this.resizeTarget.setAttribute("d", `
          //   m ${this.initialPosition.x + this.transform.translateX} ${this.initialPosition.y + this.transform.translateY}
          //   h ${this.initialPosition.width}
          //   v ${this.initialPosition.height}
          //   h -${this.initialPosition.width}
          //   z
          // `);
          this.transformedPosition = {
            x: this.initialPosition.x + this.transform.translateX,
            y: this.initialPosition.y + this.transform.translateY,
            width: this.initialPosition.width,
            height: this.initialPosition.height,
          }
          break;
        case "top-left":
          // this.resizeTarget.setAttribute("d", `
          //   m ${this.initialPosition.x + this.transform.translateX} ${this.initialPosition.y + this.transform.translateY}
          //   h ${this.initialPosition.width - this.transform.translateX}
          //   v ${this.initialPosition.height - this.transform.translateY}
          //   h -${this.initialPosition.width - this.transform.translateX}
          //   z
          // `);
          this.transformedPosition = {
            x: this.initialPosition.x + this.transform.translateX,
            y: this.initialPosition.y + this.transform.translateY,
            width: this.initialPosition.width - this.transform.translateX,
            height: this.initialPosition.height - this.transform.translateY,
          }
          break;
        case "top-right":
          // this.resizeTarget.setAttribute("d", `
          //   m ${this.initialPosition.x} ${this.initialPosition.y + this.transform.translateY}
          //   h ${this.initialPosition.width + this.transform.translateX}
          //   v ${this.initialPosition.height - this.transform.translateY}
          //   h -${this.initialPosition.width + this.transform.translateX}
          //   z
          // `);
          this.transformedPosition = {
            x: this.initialPosition.x,
            y: this.initialPosition.y + this.transform.translateY,
            width: this.initialPosition.width + this.transform.translateX,
            height: this.initialPosition.height - this.transform.translateY,
          }
          break;
        case "bottom-left":
          // this.resizeTarget.setAttribute("d", `
          //   m ${this.initialPosition.x + this.transform.translateX} ${this.initialPosition.y}
          //   h ${this.initialPosition.width - this.transform.translateX}
          //   v ${this.initialPosition.height + this.transform.translateY}
          //   h -${this.initialPosition.width - this.transform.translateX}
          //   z
          // `);
          this.transformedPosition = {
            x: this.initialPosition.x + this.transform.translateX,
            y: this.initialPosition.y,
            width: this.initialPosition.width - this.transform.translateX,
            height: this.initialPosition.height + this.transform.translateY,
          }
          break;
        case "bottom-right":
          // this.resizeTarget.setAttribute("d", `
          //   m ${this.initialPosition.x} ${this.initialPosition.y}
          //   h ${this.initialPosition.width + this.transform.translateX}
          //   v ${this.initialPosition.height + this.transform.translateY}
          //   h -${this.initialPosition.width + this.transform.translateX}
          //   z
          // `);
          this.transformedPosition = {
            x: this.initialPosition.x,
            y: this.initialPosition.y,
            width: this.initialPosition.width + this.transform.translateX,
            height: this.initialPosition.height + this.transform.translateY,
          }
          break;
      }
      this.resizeTarget.setAttribute("d", `
        m ${this.transformedPosition.x} ${this.transformedPosition.y}
        h ${this.transformedPosition.width}
        v ${this.transformedPosition.height}
        h -${this.transformedPosition.width }
        z
      `);
    }

    // determineTouchDirection(touch) {
    //   console.log(`onTouchMove`);
    //   if (
    //     !touch ||
    //     !this.initialTouch ||
    //     !touch.y ||
    //     !this.initialTouch.y
    //   ) {
    //     return false;
    //   }
    // 
    //   const xMovement = touch.x - this.initialTouch.x;
    //   const yMovement = touch.y - this.initialTouch.y;
    // 
    //   if (Math.abs(xMovement) > Math.abs(yMovement)) {
    //     this.touchDirection = xMovement > 0 ? `left` : `right`;
    //   }
    // 
    //   console.log({direction: this.touchDirection});
    // }
    getMoveTransform(touch) {
      if (
        !touch ||
        !this.initialTouch ||
        !touch.y ||
        !this.initialTouch.y
      ) {
        return; // this.transform;
      }

      const translateX = touch.x - this.initialTouch.x;
      const translateY = touch.y - this.initialTouch.y;
      
      const imageWidth = 1920;
      const imageHeight = 1080;

      const svgBounds = document.querySelector("[data-resizable-svg]").getBoundingClientRect();

      console.log({svgBounds});

      const scale = {
        x: imageWidth / svgBounds.width,
        y: imageHeight / svgBounds.height,
      }

      console.log({scale});

      return {
        translateX: translateX * scale.x,
        translateY: translateY * scale.y,
      };
    }
    onTouchRelease() {
      console.log(`onTouchRelease`);

      // console.log({direction: this.touchDirection});

      // if (!this.touchDirection) return;
      // 
      // switch (this.touchDirection) {
      //   case `right`:
      //     console.log("drag right");
      //     break;
      //   case `left`:
      //     console.log("drag left");
      //     break;
      // }
      
      this.initialTouch = {
        x: null,
        y: null
      };
      this.initialPosition = this.transformedPosition;
      // this.touchDirection = null;
    }
    constructor({dragTarget, resizeTarget}) {
      this.target = dragTarget;
      this.targetType = this.target.getAttribute("data-draggable");
      this.resizeTarget = resizeTarget;
      this.initialTouch = {
        x: null,
        y: null
      };
      this.initialPosition = {
        x: 1040,
        y: 140,
        width: 500,
        height: 300,
      };
      // this.touchDirection = null;

      // Listen for touch events
      this.target.addEventListener(`touchstart`, this.onTouchStart.bind(this));
      this.target.addEventListener(`touchmove`, this.onTouchMove.bind(this));
      this.target.addEventListener(`touchend`, this.onTouchEnd.bind(this));
      this.target.addEventListener(`mousedown`, this.onMouseDown.bind(this));
      this.target.addEventListener(`mousemove`, this.onMouseMove.bind(this));
      this.target.addEventListener(`mouseup`, this.onMouseUp.bind(this));
      window.addEventListener(`mousemove`, this.onMouseMove.bind(this));
      window.addEventListener(`mouseup`, this.onMouseUp.bind(this));
      console.log(`listening for events on ${this.target}`);
    }
  }
  const resizeTarget = document.querySelector(`[data-resizable]`);
  const targets = document.querySelectorAll(`[data-draggable]`);
  console.log({targets});

  // Listen for touch events
  for (dragTarget of targets) {
    new Draggable({dragTarget, resizeTarget});
  }
  </script>

  <footer class="details-footer annotation-details__footer">
    <div class="details-footer__action-primary">
      <button type="submit" name="verify" value="1"
        href="/image-details/"
        class="button button--medium button--primary"
        >
        Save and verify
      </button>
      <button type="submit"
        href="/image-details/"
        class="button button--medium"
        >
        Save
      </button>
    </div>
    <div class="details-footer__nav">
      <ul class="details-footer__nav-list">
        <li class="details-footer__nav-item">
          <a
            class="link link--has-active-indicator"
            href="/annotations/"
            >
            <span class="link__active-indicator">Next</span>
            <svg class="icon"><use xlink:href="#icon-arrow-right"></use></svg>
          </a>
        </li>
        <li class="details-footer__nav-item">
          <a
            class="link link--has-active-indicator"
            href="/annotations/"
            >
            <svg class="icon"><use xlink:href="#icon-arrow-left"></use></svg>
            <span class="link__active-indicator">Previous</span>
          </a>
        </li>
      </ul>
      <p class="details-footer__nav-meta">1/468 images</p>
    </div>
    <div class="details-footer__action-secondary">
      <a
        href="/image-details/"
        class="button button--medium"
        >
        Cancel
      </a>
    </div>
  </footer>

</form>
</main>
